# Class Instance Migration - Fix for "Class not found or inactive" Error

## Problem
Users were experiencing a "Class not found or inactive" error when trying to book classes. This occurred because the system used a hybrid approach where class instances could be either:
- **Real instances**: Pre-created in the database
- **Virtual instances**: Created on-demand using the format `{classId}-{date}`

The error happened when the virtual instance creation logic failed due to various conditions like invalid class IDs, inactive classes, or tenant mismatches.

## Solution
We've migrated to a **pre-generated class instances** approach, which eliminates the virtual instance creation complexity and provides a more reliable booking system.

## Changes Made

### 1. Updated Admin Dashboard
- **File**: `src/app/[slug]/admin/simple/page.tsx`
- **Added**: "Generate Class Instances" button in the admin dashboard
- **Functionality**: Allows admins to pre-generate class instances for the next 8 weeks

### 2. Simplified Booking API
- **File**: `src/app/api/bookings/route.ts`
- **Removed**: Complex virtual instance creation logic (100+ lines of code)
- **Simplified**: Now only works with pre-created instances from the database
- **Better Error Messages**: Clear message when instances haven't been generated

### 3. Instance Generation Scripts
- **File**: `generate-instances-for-all-tenants.mjs`
- **Purpose**: One-time script to generate instances for all existing tenants
- **Usage**: Run with `node generate-instances-for-all-tenants.mjs`

### 4. Existing API Endpoint
- **File**: `src/app/api/admin/generate-instances/route.ts`
- **Status**: Already existed and works perfectly
- **Integration**: Connected to the new admin dashboard button

## How to Fix the Current Issue

### Immediate Fix (Recommended)
**Use the Admin Dashboard:**
1. Go to your admin dashboard: `/{tenantSlug}/admin/simple`
2. Click the "Generate Class Instances" button
3. This will create instances for the next 8 weeks

### Alternative Fix (If Script Permissions Are Available)
```bash
cd dance-school-cms
node generate-instances-for-all-tenants.mjs
```
*Note: This requires a Sanity API token with write permissions. If you get "Insufficient permissions" errors, use the admin dashboard method instead.*

### Ongoing Management
1. **Admin Dashboard**: Admins can use the "Generate Class Instances" button in their admin panel
2. **Regular Generation**: Admins should generate new instances weekly/monthly as needed
3. **Per-Tenant Control**: Each tenant admin can generate instances for their own school

## Benefits of This Approach

### 1. Reliability
- No more complex virtual instance creation logic
- All bookable classes exist in the database
- Consistent behavior across all booking interfaces

### 2. Performance
- Faster booking process (no on-demand creation)
- Reduced database queries during booking
- Better error handling

### 3. Maintainability
- Simpler codebase (removed 100+ lines of complex logic)
- Easier to debug booking issues
- Clear separation between class management and booking

### 4. Admin Control
- Admins have full control over which instances are available
- Easy to manage class schedules
- Clear visibility into upcoming classes

## Error Messages

### Before (Confusing)
- "Class not found or inactive"
- "Invalid class instance ID format"
- "Class instance date is outside the recurring schedule range"

### After (Clear)
- "Class instance not found. Please ensure class instances have been generated by an admin."
- "Class is not active"

## Future Enhancements

1. **Automatic Generation**: Set up a cron job to automatically generate instances
2. **Bulk Management**: Add admin tools to manage multiple instances at once
3. **Calendar Integration**: Show generated instances in admin calendar views
4. **Notifications**: Alert admins when instances need to be generated

## Testing

After running the migration script, test the booking flow:

1. Visit the calendar page
2. Try booking a class
3. Verify the booking succeeds without the "Class not found or inactive" error

## Rollback Plan

If needed, the virtual instance creation logic can be restored from git history, but the pre-generated approach is recommended for production use.
